<%#
 Copyright 2008 Steven Barth <steven@midlink.org>
 Copyright 2008 Jo-Philipp Wich <jow@openwrt.org>
 Licensed to the public under the Apache License 2.0.
-%>
<%+header%>

<%-
    local iw = luci.sys.wifi.getiwinfo("wifi1.network1")
    local freqlist = iw.freqlist
        function uciget(cmd)
                local res = luci.util.exec(cmd)
                local str = string.gsub(res, "\n", "")
                return str
        end
-%>
<script src="<%=media%>/chartist.js"></script>
<script src="<%=media%>/chartist-plugin-axistitle.js" type="text/javascript"></script>
<link rel="stylesheet" href="<%=media%>/chartist.css">
<script type="text/javascript">
    var noise_off = "<%=uciget('uci get wireless.wifi1.kwnnoiseoff')%>";
	var freqlist = <%= luci.http.write_json(freqlist) %>;
    var start_freq = 0;
    var end_freq = 0;
	for (var i = 0; i < freqlist.length; i++) {
        if( start_freq == 0 )
            start_freq = freqlist[i].mhz;
        else
            end_freq = freqlist[i].mhz;
    }
function stop_scan()
{
    id = 1;
    XHR.get('<%=luci.dispatcher.build_url("admin", "monitor","tools")%>/stopscan' + '/' + id, null,
    function(x, data) {
            document.getElementById("start_button").style.display = "block";
            document.getElementById("stop_button").style.display = "none";
            document.getElementById("msg").innerHTML="";
        if (data) { 
        }
    }
    );
}
function start_scan()
{
    var reset = "";
    get_values(reset);
    var time = document.getElementById("time").value;
    var start = document.getElementById("start").value;
    var end = document.getElementById("end").value;
    document.getElementById("start_button").style.display = "none";
    document.getElementById("stop_button").style.display = "block";
    document.getElementById("msg").innerHTML="Spectral scan is in progress...";
    var scantable = document.getElementById('scan-list');
            if( scantable ) {
	            while (scantable.rows.length > 1)
		            scantable.rows[1].parentNode.removeChild(scantable.rows[1]);
            }

    		XHR.get('<%=luci.dispatcher.build_url("admin", "monitor","tools")%>/startfreq' + '/' + start, null,
			function(x, data) {
				if (data) { 
				}
			}
    		);
            
    		XHR.get('<%=luci.dispatcher.build_url("admin", "monitor","tools")%>/endfreq' + '/' + end, null,
			function(x, data) {
				if (data) { 
				}
			}
    		);

    		XHR.get('<%=luci.dispatcher.build_url("admin", "monitor","tools")%>/scantime' + '/' + time, null,
			function(x, data) {
				if (data) { 
				}
			}
    		);
}

function get_values( data )
{
    var chan_plot = new Array();
    var util_plot = new Array();
    var values = data.split(",");
    for( i = 0; i < values.length - 1; i++ )
    {
        var x = values[i].split("=");
        var chan = parseInt(x[0]);
        var freq =  x[1];
        var util = parseInt(x[2]);
        var noise = x[3].split("-");
        noise = ( noise == 0 ? 0 : parseInt( noise[1] ) );
        chan_plot.push(chan);
        util_plot.push(util);
        var scantable = document.getElementById('scan-list');
        var tr = scantable.insertRow(-1);
        tr.className = 'cbi-section-table-row cbi-rowstyle-2';
        tr.insertCell(-1).innerHTML = chan;
        tr.insertCell(-1).innerHTML = freq;
        tr.insertCell(-1).innerHTML = util;
        tr.insertCell(-1).innerHTML = noise == 0 ? 0 : noise_off - noise;
    }

      new Chartist.Line('.ct-chart', {
      labels: chan_plot,
        series: [
            util_plot
              ]
      }, 
      {
      fullWidth: true,
      axisX: {
          labelInterpolationFnc: function(value) {
              return value % 5 == 0 ? value : null;
          }
      },
      plugins: [
          Chartist.plugins.ctAxisTitle({
               axisX: {
                  axisTitle: 'Channel Number',
                  axisClass: 'ct-axis-title',
                  offset: {
                      x: 0,
                      y: 30
                  },
                  textAnchor: 'middle'
               },
               axisY: {
                  axisTitle: 'Utilization',
                  axisClass: 'ct-axis-title',
                  offset: {
                      x: 0,
                      y: 0
                  },
                  textAnchor: 'middle',
                  flipTitle: false
               }
        })
      ],
      chartPadding: {
          right: 40
      }
    });
}
	XHR.poll(5, '<%=REQUEST_URI%>', { status: 1 },
		function(x, info)
        {
            var id = 6;
            XHR.get('<%=luci.dispatcher.build_url("admin", "monitor", "tools")%>/saresult/' + id, null,
            function(x, data) {
              if (data) { 
                  var scantable = document.getElementById('scan-list');
                  if( scantable ) {
	                  while (scantable.rows.length > 1)
		                  scantable.rows[1].parentNode.removeChild(scantable.rows[1]);
                      if( data.length > 3 )
                      {
                          get_values( data );
                      }
                  }
               }
            }
            );


            XHR.get('<%=luci.dispatcher.build_url("admin", "monitor", "tools")%>/scanstate/' + id, null,
            function(x, data) {
              if (data) { 
                  if( data == 0 ) {
                      document.getElementById("start_button").style.display = "block";
                      document.getElementById("stop_button").style.display = "none";
                      document.getElementById("msg").innerHTML="";
                  }
               }
            }
            );
        }
    );

</script>
<div class="page-content">
<h2><a id="content" name="content"><%:Tools%></a></h2>
    <ul class="cbi-tabmenu">
        <li style="margin-right:4px" class="cbi-tab-disabled"><a href="<%=luci.dispatcher.build_url("admin/monitor/tools")%>"><%:Diagnostics%></a></li>
        <li style="margin-right:4px" class="cbi-tab"><a href="#"><%:Spectrum Analyzer%></a></li>
        <!--<li style="margin-right:4px" class="cbi-tab-disabled"><a href="linkcalc"><%:Link Calculator%></a></li>
        <li style="margin-right:4px" class="cbi-tab-disabled"><a href="ethtest"><%:Ethernet Test%></a></li>-->
    </ul>

<div class="cbi-map">
    <fieldset class="cbi-section">
       <form name="formTable">
        <table>
          <tr>
                <td>Scan Time&nbsp;<input type="text" class="cbi-input-select" id="time" style="width:100px;" value="">&nbsp; (1000-60000) ms</td>
                <td>Start Frequency&nbsp;<input type="text" class="cbi-input-select" id="start" style="width:100px;" value="">&nbsp; (0-10000) MHz</td>
                <td>End Frequency&nbsp;<input type="text" class="cbi-input-select" id="end" style="width:100px;" value="">&nbsp; (0-10000) MHz</td>
          </tr>
        </table>
        </form>
    </fieldset>
    <div class="cbi-page-actions right" id="start_button">
       <input type="button" class="cbi-button" value="Start" onclick="start_scan()" />
    </div>
    <div class="cbi-page-actions right" id="stop_button" style="display:none">
       <input type="button" class="cbi-button" value="Stop" onclick="stop_scan()" />
    </div>
	<fieldset class="cbi-section">
    <div id="msg"></div>
    <div class="ct-chart" style="width:100%;"></div>
		<table class="cbi-section-table" style="width:600px; margin:30px;" id="scan-list">
			<tr class="cbi-section-table-titles">
				<th class="cbi-section-table-cell"><%:Channel%></th>
				<th class="cbi-section-table-cell"><%:Frequency (MHz)%></th>
				<th class="cbi-section-table-cell"><%:Utilization (%)%></th>
				<th class="cbi-section-table-cell"><%:Noise (dBm)%></th>
            </tr>
        </table>
    </fieldset>
</div>
</div>
<script type="text/javascript">
var res = <%=luci.http.write_json(saresult)%>;
if( res. length > 3 ) {             
        get_values( res );
}
document.getElementById("time").value = 1000;
document.getElementById("start").value = start_freq;
document.getElementById("end").value = end_freq;
</script>
</div>
<%+footer%>
