<%#
 Copyright 2008-2009 Steven Barth <steven@midlink.org>
 Copyright 2008-2015 Jo-Philipp Wich <jow@openwrt.org>
 Licensed to the public under the Apache License 2.0.
-%>

<%-

	local ip = require "luci.ip"
	local fs = require "nixio.fs"
	local utl = require "luci.util"
	local uci = require "luci.model.uci".cursor()
	local ntm = require "luci.model.network"

	local has_iwinfo = pcall(require, "iwinfo")

	ntm.init(uci)

	local devices  = ntm:get_wifidevs()
	local arpcache = { }
	ip.neighbors({ family = 4 }, function(n)
		if n.mac and n.dest then arpcache[n.mac:upper()] = n.dest:string() end
	end)

    local iw = luci.sys.wifi.getiwinfo("wifi1.network1")
    local freqlist = iw.freqlist
	local netlist = { }
	local netdevs = { }

	local dev
	for _, dev in ipairs(devices) do
		local net
		for _, net in ipairs(dev:get_wifinets()) do
			netlist[#netlist+1] = net:id()
			netdevs[net:id()] = dev:name()
		end
	end

        function uciget(cmd)
                local res = luci.util.exec(cmd)
                local str = string.gsub(res, "\n", "")
                return str
        end
-%>

<%+header%>
<div class="page-content">
<% if not has_iwinfo then %>
	<div class="errorbox">
		<strong><%:Package libiwinfo required!%></strong><br />
		<%_The <em>libiwinfo-lua</em> package is not installed. You must install this component for working wireless configuration!%>
	</div>
<% end %>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">
    var radiomode = "<%=uciget('uci get wireless.@wifi-iface[1].mode')%>";
	var freqlist = <%= luci.http.write_json(freqlist) %>;
    var modelist = [ "ap=Outdoor Base", "sta=Outdoor Subscriber" ];
    var hwlist = [ /*"11a=Legacy",*/ "11na=11NA", "11ac=11AC" ];
    var acbwlist = [ "HT20=20MHz", "HT40+=40MHz", "HT80=80MHz" ];
    var nbwlist = [ "HT20=20MHz", "HT40+=40MHz" ];
    var abwlist = [ "HT20=20MHz" ];
    var counlist = [ "5018=INDIA", "5019=5GHz" ];
    var chanlist = [ "auto=Auto" ];
    if( freqlist != null ) {
	    for (var i = 0; i < freqlist.length; i++) {
		    chanlist.push(
			    '%d=%d (%d MHz)'.format(freqlist[i].channel, freqlist[i].channel, freqlist[i].mhz)
		    );
        }
    }
var def = new Array(8);
function save_def_value()
{
    var f = document.formTable;
    for (i=0; i<f.elements.length; i++)
    {
        def[i] = f.elements[i].value;
    }
}

function disable_spin()
{
    document.getElementById("spin").innerHTML = "";
}

function save_value()
{
    document.getElementById("spin").innerHTML = "<i class='fa fa-spinner fa-pulse'></i>";
    setTimeout("disable_spin()",1000);
    var setdata = "";
    var f = document.formTable;
    for( i=0; i<f.elements.length; i++)
    {
        if( def[i] != f.elements[i].value ) {
            def[i] = f.elements[i].value;
            setdata += f.elements[i].name + "=" + f.elements[i].value + "~";
        }
    }
    XHR.get('<%=luci.dispatcher.build_url("admin")%>/cfg_set' + '/' + setdata, null,
	    function(x, data) {
		    if (data) { 
                location.href='<%=luci.dispatcher.build_url("admin/wireless/radio1")%>';
		    }
	    }
    );
}

function returnoptions( list, value )
{
    var opt = "";
    for( i = 0; i < list.length; i++ )
    {
        var a = list[i].split("=");
        opt += "<option value=";
        opt += a[0];
        if( value == a[0] )
           opt += " selected";
        opt += ">" + a[1] + "</option>";
    }
    return opt;
}

function updateparam( hwvalue )
{
    var bw = "<%=uciget('uci get wireless.wifi1.htmode')%>";
    var rate = "<%=uciget('uci get wireless.wifi1.rate')%>";
    var bwlist = acbwlist;
    if( hwvalue == "11na" ) {
        bwlist = nbwlist;
    }
    if( hwvalue == "11a" ) {
        bwlist = abwlist;
    }
    var str ="<select class='cbi-input-select' name='5'>";
    str += returnoptions( bwlist, bw );
    str += "</select>";
    document.getElementById("bwid").innerHTML = str;
}

function getoptions( list, value )
{
    for( i = 0; i < list.length; i++ )
    {
        var a = list[i].split("=");
        document.write("<option value=");
        document.write(a[0]);
        if( value == a[0] )
           document.write(" selected");
        document.write(">");
        document.write(a[1]);
        document.write("</option>");
    }
}
function updatelinkid( val )
{
    if( val == "ap" ) {
       document.getElementById("wifitimer").style.display = "none";
       document.getElementById("linktimer").style.display = "none";
       document.getElementById("suservice").style.display = "none";
       document.getElementById("chan").style.display="block";
    }
    else { 
       document.getElementById("wifitimer").style.display = "block";
       document.getElementById("linktimer").style.display = "block";
       document.getElementById("suservice").style.display = "block";
       document.getElementById("chan").style.display="none";
    }
}
function updatehidessid()
{
    if( document.getElementById("hidessid2").checked == "1" )
        document.getElementById("hidessid1").value = 1;
    else
        document.getElementById("hidessid1").value = 0;
}
</script>
<h2><a id="content" name="content"><%: 5GHz Radio Configuration%></a></h2>
<div class="cbi-map">
    <ul class="cbi-tabmenu">
        <li style="margin-right:4px" class="cbi-tab"><a href="#"><%:Properties%></a></li>
        <li style="margin-right:4px" class="cbi-tab-disabled"><a href="<%=REQUEST_URI%>/mimo1"><%:MIMO%></a></li>
        <li style="margin-right:4px" class="cbi-tab-disabled"><a href="<%=REQUEST_URI%>/ddrs1"><%:DDRS/ATPC%></a></li>
        <li style="margin-right:4px" class="cbi-tab-disabled"><a href="<%=REQUEST_URI%>/security1"><%:Security%></a></li>
        <script type="text/javascript">
        if( radiomode == "ap" ) {
           document.write("<li style='margin-right:4px' class='cbi-tab-disabled'><a href='<%=REQUEST_URI%>/macacl1'><%:MAC ACL%></a></li>");
           document.write("<li style='margin-right:4px' class='cbi-tab-disabled'><a href='<%=REQUEST_URI%>/dcs1'><%:DCS%></a></li>");
        }
        </script>
    </ul>
    <fieldset class="cbi-section">
       <form name="formTable">
          <div class="cbi-value">
            <label class="cbi-value-title">Link Type</label>
            <div class="cbi-value-field">
              <select class="cbi-input-select" id="linktype" name="150"">
                 <script type="text/javascript">
                 var value = "<%=uciget('uci get wireless.wifi1.linktype')%>";
                 document.write("<option value='1'");
                 if( value == "1" )
                     document.write("selected");
                 document.write(">PTP</option>");
                 document.write("<option value='2'");
                 if( value == "2" )
                     document.write("selected");
                 document.write(">Backhaul</option>");
                 document.write("<option value='3'");
                 if( value == "3" )
                     document.write("selected");
                 document.write(">PTMP</option>");
                 </script>
              </select>
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Radio Mode</label>
            <div class="cbi-value-field">
              <select class="cbi-input-select" name="1" onchange="updatelinkid(this.value)">
                 <script type="text/javascript">
                 var mode = "<%=uciget('uci get wireless.@wifi-iface[1].mode')%>";
                 getoptions( modelist, mode );
                 </script>
              </select>
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">SSID</label>
            <div class="cbi-value-field">
              <input type="text" name="2" class="cbi-input-select" value="<%=uciget('uci get wireless.@wifi-iface[1].ssid')%>" > &nbsp; (1-32) characters
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Country</label>
            <div class="cbi-value-field">
              <select class="cbi-input-select" name="3">
                <script type="text/javascript">
                var coun = "<%=uciget('uci get wireless.wifi1.country')%>";
                getoptions( counlist, coun );
                </script>
              </select>
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Operational Mode</label>
            <div class="cbi-value-field">
              <select class="cbi-input-select" name="4" onchange="updateparam(this.value)">
                <script type="text/javascript">
                  var hw = "<%=uciget('uci get wireless.wifi1.hwmode')%>";
                  getoptions( hwlist, hw );
                </script>
              </select>
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Bandwidth</label>
            <div class="cbi-value-field" id="bwid">
            </div>
          </div>
          <div class="cbi-value" id="chan">
            <label class="cbi-value-title">Channel</label>
            <div class="cbi-value-field">
              <select class="cbi-input-select" name="6">
                 <script type="text/javascript">
                 var channel = "<%=uciget('uci get wireless.wifi1.channel')%>";
                 getoptions( chanlist, channel );
                 </script>
             </select>
           </div>
         </div>
         <div class="cbi-value">
            <label class="cbi-value-title">Distance</label>
            <div class="cbi-value-field">
              <input type="text" name="73" class="cbi-input-select" value="<%=uciget('uci get wireless.wifi1.distance')%>" > &nbsp; (1-30) Km
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Traffic Shaping</label>
            <div class="cbi-value-field">
               <select name="123" class="cbi-input-select">
               <script type="text/javascript">
                  var shaping = "<%=uciget('uci get wireless.@wifi-iface[1].shaping')%>";
                  document.write("<option value='1' ");
                  if( shaping == 1 ) {
                      document.write(" selected");
                  }
                  document.write(">Enable</option>");
                  document.write("<option value='0' ");
                  if( shaping == 0 ) {
                     document.write(" selected");
                  }
                  document.write(">Disable</option>");
                </script>
               </select>
           </div>
         </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Uplink Limit</label>
            <div class="cbi-value-field">
              <input type="text" name="10" class="cbi-input-select" value="<%=uciget('uci get wireless.@wifi-iface[1].ullmt')%>" > &nbsp; (0-867000) Kbps
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Downlink Limit</label>
            <div class="cbi-value-field">
              <input type="text" name="11" class="cbi-input-select" value="<%=uciget('uci get wireless.@wifi-iface[1].dllmt')%>" > &nbsp; (0-867000) Kbps
            </div>
          </div>
          <div class="cbi-value">
            <label class="cbi-value-title">Hide ESSID</label>
            <div style="display:none"><input type="text" id="hidessid1" name="12" value="<%=uciget('uci get wireless.@wifi-iface[1].hidden')%>"></div>
            <div class="cbi-value-field">
                 <script type="text/javascript">
                 var hide = "<%=uciget('uci get wireless.@wifi-iface[1].hidden')%>";
                 document.write("<input type='checkbox' ");
                 if( hide == 1 )
                     document.write(" checked");
                 document.write(" id='hidessid2' class='cibi-input-select' onchange='updatehidessid()' >");
              </script>
            </div>
          </div>
          <div class="cbi-value" id="wifitimer">
            <label class="cbi-value-title">Wireless Inactivity Timer</label>
            <div class="cbi-value-field">
              <input type="text" name="133" class="cbi-input-select" value="<%=uciget('uci get wireless.wifi1.wifitimer')%>" > &nbsp; Minutes
            </div>
          </div>
          <div class="cbi-value" id="linktimer">
            <label class="cbi-value-title">Link Inactivity Timer</label>
            <div class="cbi-value-field">
              <input type="text" name="134" class="cbi-input-select" value="<%=uciget('uci get wireless.wifi1.linktimer')%>" > &nbsp; Minutes
            </div>
          </div>
          <div class="cbi-value" id="suservice">
            <label class="cbi-value-title">SU Service</label>
            <div class="cbi-value-field">
               <select name="148" class="cbi-input-select">
               <script type="text/javascript">
                  var service = "<%=uciget('uci get wireless.wifi1.suservice')%>";
                  document.write("<option value='1' ");
                  if( service == 1 ) {
                      document.write(" selected");
                  }
                  document.write(">Enable</option>");
                  document.write("<option value='0' ");
                  if( service == 0 ) {
                     document.write(" selected");
                  }
                  document.write(">Disable</option>");
                </script>
               </select>
           </div>
         </div>
          <div class="cbi-value" id="icb">
            <label class="cbi-value-title">Intra Cell Blocking</label>
            <div class="cbi-value-field">
               <select name="151" class="cbi-input-select">
               <script type="text/javascript">
                  var icb = "<%=uciget('uci get wireless.wifi1.icb')%>";
                  document.write("<option value='1' ");
                  if( icb == 1 ) {
                      document.write(" selected");
                  }
                  document.write(">Enable</option>");
                  document.write("<option value='0' ");
                  if( icb == 0 ) {
                     document.write(" selected");
                  }
                  document.write(">Disable</option>");
                </script>
               </select>
           </div>
         </div>
          <div class="cbi-value" id="macinmac">
            <label class="cbi-value-title">MAC in MAC</label>
            <div class="cbi-value-field">
               <select name="152" class="cbi-input-select">
               <script type="text/javascript">
                  var macinmac = "<%=uciget('uci get wireless.wifi1.macinmac')%>";
                  document.write("<option value='1' ");
                  if( macinmac == 1 ) {
                      document.write(" selected");
                  }
                  document.write(">Enable</option>");
                  document.write("<option value='0' ");
                  if( macinmac == 0 ) {
                     document.write(" selected");
                  }
                  document.write(">Disable</option>");
                </script>
               </select>
           </div>
         </div>
    </form>
    </fieldset>
</div>
<div class="cbi-page-actions left">
<div id="spin"></div>
<input type="button" class="cbi-button" value="<%:Save%>" onclick="save_value()" />
</div>
<script type="text/javascript">
var hw = "<%=uciget('uci get wireless.wifi1.hwmode')%>";
updateparam(hw);
save_def_value();
var mode = "<%=uciget('uci get wireless.@wifi-iface[1].mode')%>";
updatelinkid( mode );
</script>
</div>
<%+footer%>
