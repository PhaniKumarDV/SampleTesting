 <%
    local sys  = require "luci.sys"
    local util = require "luci.util"
    local http = require "luci.http"
    local disp = require "luci.dispatcher"

    local boardinfo = util.ubus("system", "board")

    local request  = disp.context.path
    local request2 = disp.context.request

    local category = request[1]
    local cattree  = category and disp.node(category)

    local leaf = request2[#request2]

    local tree = disp.node()
    local node = disp.context.dispatched

    local categories = disp.node_childs(tree)

    local c = tree
    local i, r

    -- tag all nodes leading to this page
    for i, r in ipairs(request) do
        if c.nodes and c.nodes[r] then
            c = c.nodes[r]
            c._menu_selected = true
        end
    end
    
    -- send as HTML5
    http.prepare_content("text/html")

    local function nodeurl(prefix, name, query)
        local url = controller .. prefix .. name .. "/"
        if query then
            url = url .. http.build_querystring(query)
        end
        return pcdata(url)
    end

    local function subtree(prefix, node, level)
        if not level then
            level = 1
        end

        local childs = disp.node_childs(node)
        if #childs > 0 then
        
            if level > 2 then
%>
    <ul class="tabs">
        <%  
            end

            local selected_node
            local selected_name
            local i, v

            for i, v in ipairs(childs) do
                local nnode = node.nodes[v]
                if nnode._menu_selected then
                    selected_node = nnode
                    selected_name = v
                end
                if level > 2 then
        %>
            <li class="tabmenu-item-<%=v%><%- if nnode._menu_selected or (node.leaf and v == leaf) then %> active<% end %>">
                <a href="<%=nodeurl(prefix, v, nnode.query)%>"><%=striptags(translate(nnode.title))%></a>
            </li>
        <%      end
            end
            
            if level > 2 then
        %>
    </ul>
<%          end

            if selected_node then
                subtree(prefix .. selected_name .. "/", selected_node, level + 1)
            end
        end
    end
-%>
 <div class="sidebar">
 <ul class="nav">                                                                                                                          
         <%-                                                                                                                            
                local function submenu(prefix, node)                                                                                      
                        local childs = disp.node_childs(node)                                                    
                        if #childs > 0 then                                                                                                    
         %>
                                                                                                                              
         <ul class="dropdown-menu nav collapse" id="<%=pcdata(striptags(translate(node.title)))%>">                                                                                                       
                        <%-                                                                                      
                                for i, r in ipairs(childs) do                                                                                  
                                        local nnode = node.nodes[r]                                                                     
                                        local href  = controller .. prefix .. r ..                                                        
                                                (nnode.query and http.build_querystring(nnode.query) or "")      
                        %>                                                                                                                     
          <li class="<%=pcdata(striptags(translate(nnode.title)))%>"><a href="<%=pcdata(href)%>"><%=pcdata(striptags(translate(nnode.title)))%></a></li>                                       
                        <%-                                                                                                               
                                end                                                                              
                        %>                                                                                                                     
        </ul>                                                                                                                            
        <%-                                                                                                                               
                        end                                                                                      
                end                                                                                                                            
                                                                                                                                        
                childs = disp.node_childs(cattree)                                                                                        
                                                                                                                 
                if #childs > 0 then                                                                                                            
                        for i, r in ipairs(childs) do                                                                                   
                                local nnode = cattree.nodes[r]                                                                            
                                local href  = controller .. "/" .. category .. "/" .. r ..                       
                                        (nnode.query and http.build_querystring(k.query) or "")                                                
                local grandchildren = disp.node_childs(nnode)                                                                           
                                                                                                                                          
                if #grandchildren > 0 then                                                                       
        %>                                                                                                                                     
        <li class="dropdown collapsed <%=pcdata(striptags(translate(nnode.title)))%>" data-toggle="collapse" data-target="#<%=pcdata(striptags(translate(nnode.title)))%>" aria-expanded="false" >                                                                                                           
            <a class="menu" href="#"><%=pcdata(striptags(translate(nnode.title)))%></a>                                                   
            <%- submenu("/" .. category .. "/" .. r .. "/", nnode) %>                                            
        </li>                                                                                                                                   
        <%          else %>
	<li class="dropdown collapsed Monitor" data-toggle="collapse" data-target="#Monitor" aria-expanded="false">                            
            <a class="menu" href="#">Monitor</a> 
	 	<ul class="dropdown-menu nav collapse" id="Monitor">
     			<li class="ARP table"><a href="/cgi-bin/luci/;stok=bc5671fad85b43c078e9311e03ebdc2e/admin/monitor/arp">ARP</a></li>                                                                                                            
  			 <li class="Learn table"><a href="/cgi-bin/luci/;stok=bc5671fad85b43c078e9311e03ebdc2e/admin/monitor/arp">Learn</a></li>                                                                                                                     
     			<li class="WIFI Stats"><a href="/cgi-bin/luci/;stok=bc5671fad85b43c078e9311e03ebdc2e/admin/monitor/arp">WIFI</a></li>                                                                                                              
     			<li class="Ethernet Stats"><a href="/cgi-bin/luci/;stok=bc5671fad85b43c078e9311e03ebdc2e/admin/monitor/arp">Ethernet</a></li>                                                                                                                                                                                                         
		</ul>                                                       
        </li>                                                                                                                                 
             <%                                                                                                                                  
                end                                                                                                                       
                        end                                                                                      
                end                                                                                                                            
            %>                                                                                                                              
        </ul>
    </div>
